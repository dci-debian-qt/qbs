Description: add implementation of processNameByPid for GNU/kFreeBSD
Author: Dmitry Shachnev <mitya57@debian.org>
Forwarded: no
Last-Update: 2015-08-24

--- a/src/lib/corelib/tools/processutils.cpp
+++ b/src/lib/corelib/tools/processutils.cpp
@@ -41,7 +41,9 @@
 #   include <unistd.h>
 #   include <cstdio>
 #elif defined(Q_OS_BSD4)
-#   include <libutil.h>
+#   include <sys/cdefs.h>
+#   include <sys/param.h>
+#   include <sys/sysctl.h>
 #   include <sys/types.h>
 #   include <sys/user.h>
 #else
@@ -82,9 +84,21 @@
     readlink(exePath, buf, sizeof(buf));
     return FileInfo::fileName(QString::fromUtf8(buf));
 #elif defined(Q_OS_BSD4)
-    kinfo_proc *proc = kinfo_getproc(pid);
+    int mib[4] = {CTL_KERN, KERN_PROC, KERN_PROC_PID, pid};
+    size_t len = 0;
+    if (sysctl(mib, 4, NULL, &len, NULL, 0) < 0)
+        return QString();
+    kinfo_proc *proc = static_cast<kinfo_proc *>(malloc(len));
     if (!proc)
         return QString();
+    if (sysctl(mib, 4, proc, &len, NULL, 0) < 0) {
+        free(proc);
+        return QString();
+    }
+    if (proc->ki_pid != pid) {
+        free(proc);
+        return QString();
+    }
     QString name = QString::fromUtf8(proc->ki_comm);
     free(proc);
     return name;
